<!doctype html>
<html lang="sl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>‚ù§Ô∏è Za Kajo</title>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#111111">

  <style>
    body {
      font-family: -apple-system, system-ui;
      margin: 0;
      background: radial-gradient(circle at top, #1a0f14, #070708);
      color: #fff;
    }
    .wrap {
      max-width: 520px;
      margin: 0 auto;
      padding: 20px;
      display: grid;
      gap: 14px;
    }
    .card {
      background: linear-gradient(180deg, #1a1418, #120e11);
      border-radius: 22px;
      padding: 18px;
      box-shadow: 0 10px 30px rgba(0,0,0,.45);
    }
    h2, h3 {
      margin: 0 0 10px;
      letter-spacing: .3px;
    }
    img {
      width: 100%;
      border-radius: 18px;
      margin-top: 12px;
      display: none;
    }
    .row {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      align-items: center;
    }
    .chip {
      background: #222;
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 13px;
      color: #ddd;
    }
    .muted {
      color: #bdbdbd;
    }

    /* Bucket */
    .bucket-item {
      list-style: none;
      padding: 10px 12px;
      border-radius: 14px;
      background: #1f1a1e;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      user-select: none;
    }
    .bucket-item.done {
      opacity: .7;
      text-decoration: line-through;
    }
    .bucket-check {
      width: 28px;
      height: 28px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #2a2328;
      flex: 0 0 28px;
    }

    /* History */
    .history-item {
      background: #1f1a1e;
      border-radius: 14px;
      padding: 12px;
      margin-bottom: 10px;
    }
    .history-date {
      font-size: 12px;
      color: #bdbdbd;
      margin-bottom: 6px;
    }
    .history-text {
      font-size: 15px;
      line-height: 1.35;
    }
    .history-img {
      width: 100%;
      border-radius: 14px;
      margin-top: 10px;
    }
  </style>
</head>

<body>
  <div class="wrap">

    <!-- GLAVNO SPOROƒåILO -->
    <div class="card">
      <div class="row">
        <div class="chip" id="counter">‚Ä¶</div>
        <div class="chip muted" id="today">‚Ä¶</div>
      </div>

      <h2 style="margin-top:14px;">Danes zate, Kaja ‚ù§Ô∏è</h2>

      <div id="message" style="font-size:18px; line-height:1.4;">Nalagam‚Ä¶</div>
      <img id="img" alt="slika" />
    </div>

    <!-- BUCKET LIST -->
    <div class="card">
      <h3>Bucket list üß∫</h3>
      <ul id="bucket" style="padding-left:0; margin:0;"></ul>
    </div>

    <!-- ZGODOVINA -->
    <div class="card">
      <h3>Zgodovina üíå</h3>
      <div id="history" class="muted">Nalagam‚Ä¶</div>
    </div>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    const SUPABASE_URL = "https://kkubtbbdokccfxaxmwgy.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtrdWJ0YmJkb2tjY2Z4YXhtd2d5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk5NjU2NzQsImV4cCI6MjA4NTU0MTY3NH0.37AC9ilA3qKI-UyH2Tgs0XJTm3R7J2f8XFkRfUHzrR4";

    const RELATIONSHIP_START = "2025-02-05";

    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const $msg = document.getElementById("message");
    const $img = document.getElementById("img");
    const $bucket = document.getElementById("bucket");
    const $history = document.getElementById("history");

    function setImage(url){
      if(url && url.trim()){
        $img.src = url;
        $img.style.display = "block";
      } else {
        $img.style.display = "none";
        $img.removeAttribute("src");
      }
    }

    function escapeHtml(str){
      return (str ?? "").replace(/[&<>"']/g, m => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[m]));
    }

    function formatCounter(start){
      const s = new Date(start + "T00:00:00");
      const n = new Date();
      let y = n.getFullYear() - s.getFullYear();
      let m = n.getMonth() - s.getMonth();
      let d = n.getDate() - s.getDate();
      if (d < 0) {
        m--;
        d += new Date(n.getFullYear(), n.getMonth(), 0).getDate();
      }
      if (m < 0) {
        y--;
        m += 12;
      }
      return `${y} let ‚Ä¢ ${m} mesecev ‚Ä¢ ${d} dni`;
    }

    async function loadMessage(){
      const { data } = await sb
        .from("messages")
        .select("*")
        .eq("pinned", true)
        .order("created_at", { ascending:false });

      if(data && data.length){
        $msg.textContent = data[0].text ?? "";
        setImage(data[0].image_url);
      } else {
        $msg.textContent = " ";
        setImage(null);
      }
    }

    async function loadHistory(){
      const { data } = await sb
        .from("messages")
        .select("*")
        .order("created_at", { ascending:false });

      if(!data || !data.length){
        $history.textContent = "(Zaenkrat prazno)";
        return;
      }

      $history.innerHTML = data.map(m => `
        <div class="history-item">
          <div class="history-date">
            ${new Date(m.created_at).toLocaleString("sl-SI")}
          </div>
          <div class="history-text">${escapeHtml(m.text)}</div>
          ${m.image_url ? `<img class="history-img" src="${m.image_url}">` : ""}
        </div>
      `).join("");
    }

    async function loadBucket(){
      const { data } = await sb
        .from("bucket")
        .select("*")
        .order("done", { ascending:true })
        .order("created_at", { ascending:true });

      if(!data || !data.length){
        $bucket.innerHTML = "";
        return;
      }

      $bucket.innerHTML = data.map(x => `
        <li class="bucket-item ${x.done ? "done" : ""}" data-id="${x.id}" data-done="${x.done}">
          <div class="bucket-check">${x.done ? "‚úÖ" : "‚¨úÔ∏è"}</div>
          <div>${escapeHtml(x.title)}</div>
        </li>
      `).join("");
    }

    $bucket.addEventListener("click", async (e) => {
      const item = e.target.closest(".bucket-item");
      if(!item) return;

      const id = Number(item.dataset.id);
      const next = item.dataset.done !== "true";

      await sb.from("bucket").update({ done: next }).eq("id", id);
      loadBucket();
    });

    function enableRealtime(){
      sb.channel("rt-messages")
        .on("postgres_changes", { event:"*", schema:"public", table:"messages" }, () => {
          loadMessage();
          loadHistory();
        })
        .subscribe();

      sb.channel("rt-bucket")
        .on("postgres_changes", { event:"*", schema:"public", table:"bucket" }, () => {
          loadBucket();
        })
        .subscribe();
    }

    document.getElementById("counter").textContent = formatCounter(RELATIONSHIP_START);
    document.getElementById("today").textContent = new Date().toLocaleDateString("sl-SI");

    loadMessage();
    loadHistory();
    loadBucket();
    enableRealtime();
  </script>
</body>
</html>
